---
title: "Assessing the Impact of Coffee Characteristics on Quality Classification Using GLM"
author: "Group 11"
number-sections: true
format: 
  html:
    embed-resources: true
    code-tools: true
  pdf: default
editor_options: 
  chunk_output_type: console
execute:
  echo: true
  eval: true
  warning: false
  message: false
editor: 
  markdown: 
    wrap: sentence
---

```{r}
#packages library
#|echo: false
library(tidyverse)
library(moderndive)
library(gapminder)
library(sjPlot)
library(stats)
library(jtools)
```

# Introduction

(include research question)

# Data preparing & Cleaning

```{r}
#data cleaning
data<-read.csv("dataset11.csv")
data<-na.omit(data)
data$Qualityclass_dummy<-ifelse(data$Qualityclass=="Good",1,0) #for "Good"=1 "Poor"=0
data$Qualityclass <- as.factor(data$Qualityclass)
data$harvested <- as.factor(data$harvested)
data$category_two_defects<-as.numeric(data$category_two_defects)
#Outlier in altitude_mean_meters
sum(data$altitude_mean_meters>8848)+sum(data$altitude_mean_meters<0)
data=data%>%
  filter(data$altitude_mean_meters<8848 & data$altitude_mean_meters>0)

#standarized
par(mfrow=c(2,2))
plot(density(data$aroma), col = "blue", main = "Density Plot of aroma")
plot(density(data$flavor), col = "blue", main = "Density Plot of flavor")
plot(density(data$acidity), col = "blue", main = "Density Plot of acidity")
plot(density(data$altitude_mean_meters), col = "blue", main = "Density Plot of altitude_mean_meters")

#Min-Max standarized
min_max_norm=function(x){
  return((x-min(x))/(max(x)-min(x)))
}
data$altitude_mean_meters=min_max_norm(data$altitude_mean_meters)
```

-   In this dataset, aroma,flavor,acidity and altitude_mean_meters and category_two_defects are continuous variables, Qualityclass and harvested are categorical variables.

-   Through the four density plot, it shows that the first three plot nearly obey Normal distribution, but the plot of altitudes ..( complement ).
    Then we decide to scale the variable of altitudes.

    #Exploratory Data Analysis# Illuminating visualizations of the data

```{r}
library(tidyr)
#change formula
data_long <- data %>%
  pivot_longer(cols = c(aroma,flavor,acidity,category_two_defects,
                        altitude_mean_meters),
               names_to = "Variable",
               values_to = "Value")
library(ggplot2)

#boxplot
#continuous
ggplot(data = data_long, aes(x = Qualityclass, y = Value, fill = Qualityclass)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales = "free_y") +  
  theme_minimal() +
  labs(title = "Boxplots of 5 variables by quality",
       x = "qualityclass",
       y = "Value") +
  theme(legend.position = "none")
#categorical
#harvested
ggplot(data, aes(x=harvested ,  y = ..prop.., group=Qualityclass, fill=Qualityclass)) + 
    geom_bar(position="dodge", stat="count") +
    labs(y = "Proportion")
```

-   The four boxplot

-   The plot of harvested...

#Numerical Summaries

```{r}
#summary
summary(data)
#####need to add a table for summary use gt()
```

# Formal Analysis and Model Selection

$$\ln\left(\frac{p}{1-p}\right) = \alpha + \beta_1 \cdot \textrm{aroma} +
    \beta_2 \cdot \textrm{flavor}+
    \beta_3 \cdot \textrm{acidity}+ 
    \beta_4 \cdot \textrm{defects}+
    \beta_5 \cdot \textrm{altitudes}+
    \beta_6 \cdot \textrm{harvested}$$

-   (each variable need to be explain)

```{r}
#model fitted for original
model1 <- glm(Qualityclass_dummy ~ aroma+flavor+acidity+category_two_defects+altitude_mean_meters+harvested, data = data, family = binomial(link = "logit"))
summary(model1)
summ(model1)
```

-   It shows p-value of category_two_defects and harvested are higher than 0.05

```{r}
#del category_two_defects variale
model2 <- glm(Qualityclass_dummy ~ aroma+flavor+acidity+altitude_mean_meters+harvested, data = data, family = binomial(link = "logit"))
summary(model2)
summ(model2)
```

-   AIC decreased

```{r}
#del harvested variale
model3 <- glm(Qualityclass_dummy ~ aroma+flavor+acidity+altitude_mean_meters, data = data, family = binomial(link = "logit"))
summary(model3)
summ(model3)
```

-   AIC decreased

-   We see that the coefficient for....

```{r}
#del harvested variable
model4 <- glm(Qualityclass_dummy ~ aroma+flavor+acidity, data = data, family = binomial(link = "logit"))
summary(model4)
summ(model4)
####### need a table for summ
```

```{r}
library(broom)
library(knitr)
library(dplyr)
Models<-c('model1','model2','model3','model4')
model.comp.values.model1<-glance(model1)
kable(model.comp.values.model1,digits=2)
model.comp.values.model2<-glance(model2)
kable(model.comp.values.model2,digits=2)
model.comp.values.model3<-glance(model3)
kable(model.comp.values.model3,digits=2)
model.comp.values.model4<-glance(model4)
kable(model.comp.values.model4,digits=2)

model_table <- bind_rows(
  data.frame(Model = "model1", AIC = AIC(model1, k = 2), BIC = BIC(model1)),
  data.frame(Model = "model2", AIC = AIC(model2, k = 2), BIC = BIC(model2)),
  data.frame(Model = "model3", AIC = AIC(model3, k = 2), BIC = BIC(model3)),
  data.frame(Model = "model4", AIC = AIC(model4, k = 2), BIC = BIC(model4))
)

kable(model_table, digits = 2, caption = "Comparison for the 4 models")
```

-   It shows aroma, flavor, acidity, altitude_mean_meters are both significant these varibales will be saved and AIC decreased to min.

# (Analysis) optimization model (final model)

$$\ln\left(\frac{p}{1-p}\right) = \alpha + \beta_1 \cdot \textrm{aroma} +
    \beta_2 \cdot \textrm{flavor}+
    \beta_3 \cdot \textrm{acidity}+ 
    \beta_4 \cdot \textrm{altitudes}$$

-   (elements explains)

```{r}
levels(data$Qualityclass) #base on "good"
#for original model
mod1coefs1 <- round(coef(model1), 2)
library(knitr)
confint(model1) %>%
  kable()
#for optimization model
mod1coefs3 <- round(coef(model3), 2)
library(knitr)
confint(model3) %>%
  kable()
```

### log-odds

```{r}
mod.coef.logodds<-model3 %>%
                  summary() %>%
                  coef()
```

```{r}
#| fig-cap: the log-odds of explanatory variables for quality good
#| figure: fig1
plot_model(model3, show.values = TRUE, transform = NULL,
           title = "Log-Odds (quality-good)", show.p = FALSE)
```

```{r}
data<- data%>%
      mutate(logodds.good = predict(model3))
```

-   Log-odds plot shows.....

### odds

```{r}
model3 %>%
 coef() %>%
  exp()
```

```{r}
#check value
exp(coef(model3))
#odd ratrio for quality good
plot_model(model3, show.values = TRUE, axis.lim=c(0,10000),
           title = "Odds (quality-good)", show.p = FALSE)
data<- data%>%
      mutate(odds.good = exp(logodds.good))
data<- data%>%
      mutate(prob.good = fitted(model3))
```

-    We interpret the odds ratios as follows:....

### probability continuous

```{r}
#aroma/acidity/flavor/altitude_mean_meters prob
library(ggplot2)
library(tidyr)
library(dplyr)
data_long1 <- data %>%
 pivot_longer(cols = c(aroma, flavor,acidity), names_to = "Type", values_to = "Value")
# plot
ggplot(data = data_long1, aes(x =Value, y =prob.good, color = Type)) +
 geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
 labs(x = "score", y = "Probability of quality being good", color = "character") +
 theme_minimal()
ggplot(data = data, aes(x =altitude_mean_meters, y =prob.good)) +
 geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
 labs(x = "score", y = "Probability of quality being good", color = "character") +
 theme_minimal()
```

```{r}
library(grid)
library(gridExtra)
#plot

p1=plot_model(model3, type = "pred",terms = "aroma" ,title = "Aroma",
            axis.title = c("aroma", "Prob. of quality being good"))
p2=plot_model(model3, type = "pred", terms="flavor",title = "Flavor",
            axis.title = c("flavor", "Prob. of quality being good"))
p3=plot_model(model3, type = "pred",terms = "acidity", title = "Acidity",
            axis.title = c("acidity", "Prob. of quality being good"))
p4=plot_model(model3, type = "pred",terms = "altitude_mean_meters", title = "altitude_mean_meters",
            axis.title = c("altitude_mean_meters", "Prob. of quality being good"))
#merge
grid.arrange(p1,p2,p3,p4,nrow=2)

```

# Conclusion

-   1 Finally, we choose Model 3....

-   2 Through the log-odds and odds ratio plots, flavor was the most important factor in this research....

-   3....

-   4....
